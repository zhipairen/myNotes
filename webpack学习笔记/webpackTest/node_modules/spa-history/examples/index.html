<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="../HashHistory.js"></script>
    <script src="../PathHistory.js"></script>
    <title>SPA History</title>
  </head>

  <body>
    <div id="main"></div>

    <script>
    const views = {
      '/': class {
        constructor(container, history) {
          container.innerHTML = `
            <h1>Home</h1>
            <p>Open console to see logs.</p>
            <a href="${history.url('/product')}">/product</a>
            <button class="set-state">setState({ foo: 123 })</button>
            <button class="get-state">get state</button>
            `

          container.querySelector('.set-state').addEventListener('click', () => {
            history.setState({ foo: 123 })
          })

          container.querySelector('.get-state').addEventListener('click', () => {
            console.log(history.current.state)
          })
        }
      },

      '/product': class {
        constructor(container, history) {
          container.innerHTML = `
            <h1>Product Page</h1>
            <a href="${history.url('/')}">/</a>
            <a href="${history.url('/product')}">/product</a>
            <a href="${history.url('/product#foo')}">/product#foo</a>
            <a href="${history.url('/product#bar')}">/product#bar</a>
            <a href="${history.url('/buy')}">/buy</a>
            <button class="back">back({ state: { foo: 456 } })</button>
            `

          container.querySelector('.back').addEventListener('click', () => {
            history.back({ state: { foo: 456 } })
          })
        }
      },

      '/buy': class {
        constructor(container, history) {
          container.innerHTML = `
            <h1>Order Form</h1>
            <p>User: ${window.loginUser}</p>
            <p>Phone: <input type="text" class="phone"> <button class="submit">Submit</button></p>
            `

          container.querySelector('.submit').addEventListener('click', e => {
            this.beforeLeave = null

            history.back({ silent: true }).then(() => {
              history.push({
                path: '/complete',
                state: {
                  phone: container.querySelector('.phone').value
                }
              })
            })
          })
        }

        static beforeEnter(to, from) {
          console.log('beforeEnter')
          if (!window.loginUser) {
            return {
              path: '/login',
              query: {
                redirect: '/buy'
              },
              hidden: true
            }
          }
        }

        beforeLeave(to, from) {
          return window.confirm('Are you sure you want to leave?')
        }
      },

      '/complete': class {
        constructor(container, history) {
          container.innerHTML = `
            <h1>Complete</h1>
            <p>User: ${window.loginUser}</p>
            <p>Phone: ${history.current.state.phone}</p>
            `
        }
      },

      '/login': class {
        constructor(container, history) {
          container.innerHTML = `
            User: <input type="text" class="user"><button class="btn-login">login</button>
            `

          container.querySelector('.btn-login').addEventListener('click', () => {
            window.loginUser = container.querySelector('.user').value
            history.replace(history.current.query.get('redirect') || '/')
          })
        }
      }
    }

    const elMain = document.getElementById('main')
    let currentView = null

    let _History = HashHistory
    if (location.protocol.slice(0, 4) === 'http') {
      if (confirm('Use PathHistory?')) _History = PathHistory
    }

    const history = new _History({
      beforeChange(to, from) {
        console.log('------------')
        console.log('beforeChange')
        console.log('to:', to)
        console.log('from:', from)

        return Promise.resolve(currentView && currentView.beforeLeave && currentView.beforeLeave(to, from)).then(ret => {
          if (ret == null || ret === true) {
            const ToView = views[to.path]
            return ToView.beforeEnter && ToView.beforeEnter(to, from)
          } else {
            return ret
          }
        })
      },

      change(to) {
        console.log('------------')
        console.log('change')
        console.log('to:', to)

        elMain.innerHTML = ''
        currentView = new views[to.path](elMain, history)
      }
    })

    history.hookAnchorElements(document.body)
    history.start()
    </script>
  </body>
</html>
